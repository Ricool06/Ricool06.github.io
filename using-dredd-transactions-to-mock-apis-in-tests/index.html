<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-post-template-jsx.05b085e98b832830ca09.css">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{color:#398;background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:georgia,serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}</style><meta name="generator" content="Gatsby 2.0.98"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#339988"/><style data-styled="" data-styled-version="4.1.3"></style><link as="script" rel="preload" href="/webpack-runtime-292ffabcb1473dfd99be.js"/><link as="script" rel="preload" href="/app-b49a13ebb920a3351a8d.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-jsx-65d97daf44f32b1a341d.js"/><link as="fetch" rel="preload" href="/static/d/831/path---using-dredd-transactions-to-mock-apis-in-tests-8-f-7-300-Yif4JJFfr4ZuAvFVuKtr50el5Ok.json" crossOrigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div style="background:#339988;margin-bottom:1.45rem"><div style="margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;display:flex"><h1 style="margin:0;flex:1 1 auto"><a style="color:white;text-decoration:none" href="/">Ricool&#x27;s Blog</a></h1><div style="width:50px;margin-left:1px"><a href="https://github.com/Ricool06"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div style="width:100%;padding-bottom:100%"></div><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAB5UlEQVQ4y41UPUtDQRC8fEisBbWwEPwDlhZiE9BC1Egq0dI+BNFKbVLYpLFJp6UWViKIwUIR7YPaBsQyoAgq+JW8OBvnwuTxoi5M9t7e7dzc3W5cs9l0ZuaBhKNhPA5sAWXgOgiCa44tNi7rEphrcyhZjOMx4Lz5t9maMebEupHlJOEL+KSvE19Q42Pech2k+IkzsBKhIvhnbIUcLS6HXdMyeQosAmf8NkXPxCdjNrfEtd7S/shxoCITqxJPY7NR+D5ilDF/qlXJq7QU4ifLwBt9kaqTrothTZK+GMrNWnBPjmY248uBKuO88Jh8J7hmRnMhYs+CVZF9KSrcLwp1fCn5VSelYbYj9xdJ6uNSHbtaZo5l4An3tab+IIzxrveFMLCJmki+sTaSO+sg0UaQTW8lv2Y7+Fpq0M/KsROh+2o/FtVlRF2rhm1Bnh9P9K/AVNQxQ7Fp4JE5H/R5mxgAXoA7YAG45+QFsA4VvZ7ExohtAlehnjd7AAad9jESDuEm5F6P5ZH8I5xI7TWkftfCRzgk6TLcEDAJ9Auh744NErzLUY+UyP91pUBW5oIDYBuYkwdKUmGBa+oUYIpTyuV8szNYkPspMdYT0b927wXJi3e0UZv9ZzxMhRlR6DtjHgJK8CMRp3TfzpY9/Hu8WEYAAAAASUVORK5CYII=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition:opacity 0.5s;transition-delay:0.25s"/><noscript><picture><source srcSet="/static/472739dfb5857b1f659f4c4c6b4568d0/b9619/github.png 13w,
/static/472739dfb5857b1f659f4c4c6b4568d0/b5fbc/github.png 25w,
/static/472739dfb5857b1f659f4c4c6b4568d0/61df9/github.png 50w,
/static/472739dfb5857b1f659f4c4c6b4568d0/165ed/github.png 75w,
/static/472739dfb5857b1f659f4c4c6b4568d0/16ecd/github.png 100w,
/static/472739dfb5857b1f659f4c4c6b4568d0/f6d2c/github.png 120w" sizes="(max-width: 50px) 100vw, 50px" /><img src="/static/472739dfb5857b1f659f4c4c6b4568d0/61df9/github.png" alt="" style="position:absolute;top:0;left:0;transition:opacity 0.5s;transition-delay:0.5s;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></a></div><div style="width:50px;margin-left:1px"><a href="https://twitter.com/Ricool06"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div style="width:100%;padding-bottom:100%"></div><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAABsklEQVQ4y4VVu0rEUBC9um63iFiK2An6HVaWsiCIaUxjYW/jH1hoswr+RYrFzk8Q/ACFgOkUwfcjN4ln1rnhZDaSgcMk9945mdeduKqqnAj0jECfB0AMJEAGeEWma7I3aLFzNZlTKcsywntadYuciYJdzWHIzsggV5QGYT3IqEFK7o6IyOszE4kUuhd0zqS1cxpmRR55Ignam5A9a+FwVIC0w6hQ/QiMYXyr7z/kZToplFYsbIo8A+dE+qX6GlhSJxZBugt9QnkViZ22ARM+qdEWcE/EQ01Pn4pwSKkSSZz2Vggr5GtbDRaAPeACWNe1WUrVg0lN5kxFRT7gxYZrEaxzV6zIWVs4SxiSfyBdD/RAMieablRP9bAlMs8hM+ErsEZXa+KdehgIx6bV6pCTlg2RI2Becqbeiu4r2Y7xrlGU2FRK2uQNeAf2G5f+73kT+DT92Wgbbmz52gtwDCwTiXi3CpxSBIWpcBomkBhE5kty6A64Qt4uoW+oT5mMw40a08YMh+KfkZWbuz09HHh8EanItyKnYdE9vuxM1PA7ByxSkdYTxpC1/gJweOoXgLXOX8AvPJbuI2bVKiYAAAAASUVORK5CYII=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition:opacity 0.5s;transition-delay:0.25s"/><noscript><picture><source srcSet="/static/1f75d678b5526b783b2918b76f3262e7/b9619/twitter.png 13w,
/static/1f75d678b5526b783b2918b76f3262e7/b5fbc/twitter.png 25w,
/static/1f75d678b5526b783b2918b76f3262e7/61df9/twitter.png 50w,
/static/1f75d678b5526b783b2918b76f3262e7/165ed/twitter.png 75w,
/static/1f75d678b5526b783b2918b76f3262e7/16ecd/twitter.png 100w,
/static/1f75d678b5526b783b2918b76f3262e7/8d2e3/twitter.png 150w,
/static/1f75d678b5526b783b2918b76f3262e7/81c8d/twitter.png 400w" sizes="(max-width: 50px) 100vw, 50px" /><img src="/static/1f75d678b5526b783b2918b76f3262e7/61df9/twitter.png" alt="" style="position:absolute;top:0;left:0;transition:opacity 0.5s;transition-delay:0.5s;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></a></div></div></div><div style="margin:0 auto;max-width:960px;padding:0px 1.0875rem 1.45rem;padding-top:0"><div class="blog-post-container"><div class="blog-post"><h1>Using Dredd transactions to mock APIs in tests</h1><h2>March 18, 2019</h2><div class="blog-post-content"><p>Just a quick one today. I've been working on my final year project at university, and I've decided to use <a href="https://dredd.org/en/latest/">dredd</a> for contract testing my services. One stumbling block I came across was testing the frontend against these contracts. I discovered a way to get around this problem by generating mock responses using <a href="https://github.com/apiaryio/dredd-transactions">dredd-transactions</a> which is the library dredd itself uses to create transaction objects under the hood.</p>
<p>Let's get on with it shall we?</p>
<h3>The Setup</h3>
<p>My project's frontend is an Angular 7 application, using protractor for its E2E tests, as is standard. The frontend calls <a href="https://openaq.org">OpenAQ's</a> API and displays air quality measurements on a map. <a href="https://github.com/Ricool06/breathe">Check out the code if you're interested</a>.</p>
<h3>The Contract</h3>
<p>In a folder called <code>blueprints</code>, I have documented the parts of OpenAQ's API that I am using. I've used <a href="https://apiblueprint.org/">API Blueprint</a> for this documentation, then I convert it to <a href="https://swagger.io/">Swagger/OpenAPI JSON</a> during the tests using <a href="https://github.com/kminami/apib2swagger">apib2swagger</a>, but feel free to use Swagger or API blueprint directly if you prefer, as dredd supports both. I find that my approach gives me the best of both worlds, however, with the readability of API Blueprint, and the ability to use the Swagger JSON file in unit tests rather than bloating them with hundreds of object literals.</p>
<h3>The Code</h3>
<p>Before any of the tests run, in my <code>beforeAll</code> section, I read the content of the blueprint file into a variable, to prevent excessive disk IO before every test. I also set up a CORS-enabled express instance, which listens for any request sent to it, and forwards it onto a utility method, <code>matchRequestWithResponse</code>.</p>
<pre><code>let transactionsMap;
let openaqBlueprint;
let openaqBlueprintFilePath;
let mockOpenaqApiServer;

beforeAll(() => {
  transactionsMap = new Map&#x3C;string, any>();

  openaqBlueprintFilePath = `${__dirname}/../../blueprints/openaq.apib.md`;
  openaqBlueprint = readFileSync(openaqBlueprintFilePath, 'utf8');

  const mockOpenaqApi = express();
  mockOpenaqApi.use(cors());

  mockOpenaqApi.all('*', matchRequestWithResponse);

  mockOpenaqApiServer = mockOpenaqApi.listen(environment.openaqApi.port);
});
</code></pre>
<p>Then, before each test, the blueprint is compiled into a set of dredd transactions (basically request/response pairs) and added to a map with the HTTP method and URI forming the key.</p>
<pre><code>beforeEach(() => {
  dt.compile(openaqBlueprint, openaqBlueprintFilePath, (error, result) => {
    expect(error).toBeFalsy();
    result.transactions
      .map(transaction => transactionsMap.set(
        generateTransactionMapKey(transaction.request.method, transaction.request.uri),
        transaction));
  });

  page = new MapPage();
});

function generateTransactionMapKey(method, uri) {
  return `${method} ${url.parse(uri).pathname}`;
}
</code></pre>
<p>When a request is made by the app to the mock server, that request is matched up with the transaction in the map, then the response counterpart is returned by the express server. This is done by the <code>matchRequestWithResponse</code> function mentioned earlier.</p>
<pre><code>function matchRequestWithResponse(req: express.Request, res: express.Response) {
  const { response } = transactionsMap.get(generateTransactionMapKey(req.method, req.url));

  res.status(response.status).json(JSON.parse(response.body));
}

function generateTransactionMapKey(method, uri) {
  return `${method} ${url.parse(uri).pathname}`;
}
</code></pre>
<h3>Bonus: Unit Tests</h3>
<p>The Swagger JSON can also be imported into unit tests for sample data too, with a couple of caveats:</p>
<ul>
<li>The TypeScript compiler option <code>resolveJsonModule</code> must be set to true in <code>tsconfig.json</code>. </li>
<li>When you import the Swagger file <strong>the object is cached</strong>, meaning you should probably clone the object if you plan on changing some of the values if you don't want to break subsequent tests that rely on the original data. (<a href="https://lodash.com/">Lodash</a> has a nice <code>cloneDeep</code> function I like to use.)</li>
</ul>
<h3>Conclusion</h3>
<p>I've found this method works quite well so far, and I can be sure that if OpenAQ's API ever changes, I can simply change the blueprint and fix any failing tests. More importantly, when I come to include my own backend services, I can facilitate the consumer-driven-contracts pattern for testing the frontend by automatically mocking my backend service. Any tests between multiple backend services can simply run dredd the traditional way, giving me confidence that all of the services in my system work together without <em>necessarily</em> needing a full suite of system tests.</p>
<p>I'm still learning, so there might be a glaring issue with this approach that I'm not yet aware of. If so, feel free to contact me on <a href="https://twitter.com/Ricool06">Twitter</a>!</p></div></div></div><footer>©<!-- -->2019<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-template-jsx","jsonName":"using-dredd-transactions-to-mock-apis-in-tests-8f7","path":"/using-dredd-transactions-to-mock-apis-in-tests"};window.dataPath="831/path---using-dredd-transactions-to-mock-apis-in-tests-8-f-7-300-Yif4JJFfr4ZuAvFVuKtr50el5Ok";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b49a13ebb920a3351a8d.js"],"component---src-templates-post-template-jsx":["/component---src-templates-post-template-jsx.05b085e98b832830ca09.css","/component---src-templates-post-template-jsx-65d97daf44f32b1a341d.js"],"component---src-pages-404-jsx":["/component---src-pages-404-jsx.05b085e98b832830ca09.css","/component---src-pages-404-jsx-68736e3edff2dbcb6eb9.js"],"component---src-pages-index-jsx":["/component---src-pages-index-jsx.05b085e98b832830ca09.css","/component---src-pages-index-jsx-ec05eedb883c25403192.js"],"pages-manifest":["/pages-manifest-fc371bc1759be7438d0f.js"]};/*]]>*/</script><script src="/component---src-templates-post-template-jsx-65d97daf44f32b1a341d.js" async=""></script><script src="/app-b49a13ebb920a3351a8d.js" async=""></script><script src="/webpack-runtime-292ffabcb1473dfd99be.js" async=""></script></body></html>